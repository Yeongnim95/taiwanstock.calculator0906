<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股交易金額計算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', 'Arial', sans-serif;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 50%, rgba(231, 76, 60, 0.8) 100%);
        min-height: 100vh;
        padding: 20px;
        position: relative;
    }

    /* 背景柔化效果 */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.6) 0%, 
            rgba(118, 75, 162, 0.6) 25%,
            rgba(155, 89, 182, 0.5) 50%,
            rgba(231, 76, 60, 0.6) 75%,
            rgba(236, 112, 99, 0.5) 100%);
        backdrop-filter: blur(1px);
        -webkit-backdrop-filter: blur(1px);
        z-index: -1;
    }

    .container {
        max-width: 700px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    /* 底部註記 */
    .footer-note {
        background: rgba(44, 62, 80, 0.9);
        color: white;
        text-align: center;
        padding: 15px;
        font-size: 0.9em;
        border-radius: 0 0 20px 20px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    .menu-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #2c3e50;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        z-index: 1000;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .menu-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.05);
    }

    /* 側邊選單 */
    .side-menu {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        transition: left 0.3s ease;
        z-index: 999;
        padding: 80px 0 20px 0;
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
    }

    .side-menu.open {
        left: 0;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 998;
    }

    .menu-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .menu-item {
        display: block;
        padding: 20px 30px;
        color: white;
        text-decoration: none;
        font-size: 1.1em;
        font-weight: 500;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        padding-left: 40px;
    }

    .menu-item.active {
        background: rgba(255, 255, 255, 0.2);
        border-left: 4px solid #3498db;
    }

    .menu-item.disabled {
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
    }

    .menu-item.disabled:hover {
        background: none;
        padding-left: 30px;
    }

    .menu-title {
        padding: 0 30px 20px 30px;
        color: white;
        font-size: 1.3em;
        font-weight: bold;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 10px;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50, #3498db, #e74c3c);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
    }

    .header p {
        opacity: 0.9;
        font-size: 1.1em;
    }

    .form-container {
        padding: 30px;
    }

    .info-box {
        background: #e8f4fd;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
    }

    .info-box h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-family: inherit;
    }

    .info-box .tick-info {
        font-size: 0.9em;
        color: #555;
        font-family: inherit;
    }

    .form-group {
        margin-bottom: 25px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
        font-size: 1.1em;
        font-family: inherit;
    }

    .required {
        color: #e74c3c;
        font-family: inherit;
    }

    select, input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s ease;
        font-family: inherit;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    input[type="number"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
        appearance: none;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    select:focus, input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* iOS Safari 特殊處理 */
    @supports (-webkit-touch-callout: none) {
        select, input {
            font-size: 16px; /* 防止 iOS 縮放 */
        }
    }

    .price-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .price-input-container {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .stock-type-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .radio-group {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .radio-group:hover {
        border-color: #3498db;
        background-color: #f8f9fa;
    }

    .radio-group input[type="radio"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.2);
    }

    .radio-group.active {
        border-color: #3498db;
        background-color: #e3f2fd;
    }

    .radio-group label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
    }

    .calculate-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #3498db 0%, #e74c3c 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        font-family: inherit;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }

    .calculate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        background: linear-gradient(135deg, #2980b9 0%, #c0392b 100%);
    }

    .calculate-btn:active {
        transform: translateY(0);
    }

    .results {
        display: none;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
    }

    .result-section {
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .result-section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3em;
        font-family: inherit;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-family: inherit;
    }

    .result-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.1em;
    }

    .buy-section {
        border-left: 4px solid #27ae60;
    }

    .buy-section .result-item:last-child {
        color: #27ae60;
    }

    .sell-section {
        border-left: 4px solid #e74c3c;
    }

    .sell-section .result-item:last-child {
        color: #e74c3c;
    }

    .profit-section {
        border-left: 4px solid #f39c12;
    }

    .profit-positive {
        color: #27ae60;
        font-weight: bold;
    }

    .profit-negative {
        color: #e74c3c;
        font-weight: bold;
    }

    .profit-zero {
        color: #7f8c8d;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        .container {
            margin: 10px;
            border-radius: 15px;
        }

        .header {
            padding: 20px;
        }

        .header h1 {
            font-size: 1.6em;
        }

        .form-container {
            padding: 20px;
        }

        .price-group,
        .stock-type-group {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .calculate-btn {
            font-size: 1.1em;
            padding: 16px;
        }

        .result-item {
            font-size: 0.95em;
        }

        .menu-btn {
            width: 45px;
            height: 45px;
            top: 15px;
            left: 15px;
        }

        .side-menu {
            width: 250px;
            left: -250px;
        }
    }

    @media (max-width: 480px) {
        body {
            padding: 5px;
        }

        .header h1 {
            font-size: 1.4em;
        }

        .form-container {
            padding: 15px;
        }

        .info-box {
            padding: 12px;
        }

        .info-box table {
            font-size: 0.85em;
        }

        .info-box th,
        .info-box td {
            padding: 6px !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .result-section {
            padding: 15px;
        }

        .result-item {
            font-size: 0.9em;
            padding: 6px 0;
        }

        .menu-btn {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            font-size: 1.3em;
        }

        .side-menu {
            width: 220px;
            left: -220px;
        }

        .footer-note {
            font-size: 0.8em;
            padding: 12px;
        }
    }

    /* 超小螢幕優化 */
    @media (max-width: 360px) {
        .header h1 {
            font-size: 1.2em;
        }

        .form-container {
            padding: 10px;
        }

        .info-box table {
            font-size: 0.8em;
        }

        .calculate-btn {
            font-size: 1em;
            padding: 14px;
        }

        .side-menu {
            width: 200px;
            left: -200px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- 功能表按鈕 -->
        <button class="menu-btn" onclick="toggleMenu()">☰</button>

```
    <!-- 側邊選單 -->
    <div class="menu-overlay" onclick="closeMenu()"></div>
    <nav class="side-menu" id="sideMenu">
        <div class="menu-title">📊 交易計算器</div>
        <a href="#" class="menu-item active" onclick="selectMenuItem(this, 'taiwan')">
            台股交易
        </a>
        <a href="#" class="menu-item disabled" onclick="selectMenuItem(this, 'foreign')">
            複委託交易 <span style="font-size: 0.8em; color: rgba(255,255,255,0.6);">(開發中)</span>
        </a>
    </nav>
    <div class="header">
        <h1>📈 台股交易計算器</h1>
        <p>精準計算您的股票交易成本與損益</p>
    </div>

    <div class="form-container">
        <!-- 價格跳動單位說明表格 -->
        <div class="info-box">
            <h4>📊 台股價格跳動單位參考表</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">股價區間</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">跳動單位</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">範例</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">10元以下</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">0.01元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">9.98, 9.99, 10.00</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">10元~未滿50元</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">0.05元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">10.00, 10.05, 10.10...49.95</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">50元~未滿100元</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">0.1元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">50.0, 50.1, 50.2...99.9, 100.0</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">100元~未滿500元</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">0.5元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">100.0, 100.5, 101.0...499.5, 500.0</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">500元~未滿1000元</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">1元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">500, 501, 502...999, 1000</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">1000元以上</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">5元</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">1000, 1005, 1010, 1015...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <form id="stockCalculator">
            <!-- 券商選擇 -->
            <div class="form-group">
                <label for="broker">券商選擇</label>
                <select id="broker" required>
                    <option value="">請選擇券商</option>
                    <option value="fubon">富邦證券</option>
                    <option value="shinko">新光證券</option>
                    <option value="president">統一證券</option>
                    <option value="sinopac">永豐證券</option>
                    <option value="taishin">台新證券</option>
                    <option value="pocketsec">口袋證券</option>
                    <option value="landbank">土銀證券</option>
                    <option value="bot">臺銀證券</option>
                    <option value="megasec">兆豐證券</option>
                    <option value="tcbsec">合庫證券</option>
                    <option value="changhuasec">彰銀證券</option>
                    <option value="ctbc">中國信託證券</option>
                    <option value="firstsec">第一金證券</option>
                    <option value="sunnybank">陽信證券</option>
                    <option value="esun">玉山證券</option>
                    <option value="kgi">凱基證券</option>
                    <option value="yuanta">元大證券</option>
                    <option value="cathaysec">國泰證券</option>
                    <option value="capital">群益證券</option>
                    <option value="masterlink">元富證券</option>
                    <option value="entrust">華南永昌證券</option>
                    <option value="custom">🔧 自選折數</option>
                </select>
            </div>

            <!-- 自選折數輸入區 -->
            <div class="form-group" id="customDiscountGroup" style="display: none;">
                <label for="customDiscount">自訂手續費折數</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.9em; margin-bottom: 5px;">折數 (例如：6折輸入6)</label>
                        <input type="number" id="customDiscount" step="0.1" min="0.1" max="10" placeholder="請輸入折數">
                    </div>
                    <div>
                        <label style="font-size: 0.9em; margin-bottom: 5px;">零股最低手續費 (元)</label>
                        <input type="number" id="customMinFee" step="1" min="1" max="50" placeholder="預設1元" value="1">
                    </div>
                </div>
            </div>

            <!-- 股票價格 -->
            <div class="form-group">
                <label>股票價格 <span style="color: #e74c3c; font-size: 0.9em;">*至少填入一個</span></label>
                <div class="price-group">
                    <div class="price-input-container">
                        <label for="buyPrice" style="font-size: 0.9em; margin-bottom: 5px;">
                            買進價格 (元) <span style="color: #666; font-size: 0.8em;">選填</span>
                        </label>
                        <input type="number" id="buyPrice" step="0.01" min="0" placeholder="買進價格">
                    </div>
                    <div class="price-input-container">
                        <label for="sellPrice" style="font-size: 0.9em; margin-bottom: 5px;">
                            賣出價格 (元) <span style="color: #666; font-size: 0.8em;">選填</span>
                        </label>
                        <input type="number" id="sellPrice" step="0.01" min="0" placeholder="賣出價格">
                    </div>
                </div>
            </div>

            <!-- 交易類型 -->
            <div class="form-group">
                <label>交易類型 <span class="required">*必選</span></label>
                <div class="stock-type-group">
                    <div class="radio-group" onclick="selectStockType('lot', this)">
                        <input type="radio" id="lot" name="stockType" value="lot" required>
                        <label for="lot" style="margin: 0; cursor: pointer;">整張交易</label>
                    </div>
                    <div class="radio-group" onclick="selectStockType('odd', this)">
                        <input type="radio" id="odd" name="stockType" value="odd" required>
                        <label for="odd" style="margin: 0; cursor: pointer;">零股交易</label>
                    </div>
                </div>
            </div>

            <!-- 數量 -->
            <div class="form-group">
                <label for="quantity" id="quantityLabel">數量 <span class="required">*必選</span></label>
                <input type="number" id="quantity" min="1" placeholder="請輸入數量 (預設為1)" value="1">
            </div>

            <button type="submit" class="calculate-btn">💰 計算交易成本與損益</button>
        </form>

        <!-- 計算結果 -->
        <div id="results" class="results">
            <!-- 結果會動態插入到這裡 -->
        </div>
    </div>

    <!-- 底部註記 -->
    <div class="footer-note">
        ⚠️ 註：交易有賺有賠，請小心交易。
    </div>
</div>

<script>
    // 等待DOM載入完成
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
    });

    // 功能表控制
    function toggleMenu() {
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.querySelector('.menu-overlay');
        
        if (sideMenu.classList.contains('open')) {
            closeMenu();
        } else {
            sideMenu.classList.add('open');
            overlay.classList.add('active');
        }
    }

    function closeMenu() {
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.querySelector('.menu-overlay');
        
        sideMenu.classList.remove('open');
        overlay.classList.remove('active');
    }

    function selectMenuItem(element, type) {
        if (element.classList.contains('disabled')) {
            return; // 不允許點擊開發中的項目
        }
        
        // 移除所有 active 狀態
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // 添加 active 狀態到當前項目
        element.classList.add('active');
        
        // 關閉選單
        closeMenu();
        
        // 這裡可以根據 type 切換不同頁面
        if (type === 'taiwan') {
            // 當前就是台股頁面，不需要做任何事
            console.log('切換到台股交易頁面');
        } else if (type === 'foreign') {
            // 複委託頁面（開發中）
            console.log('複委託交易頁面開發中');
        }
    }

    // 初始化事件監聽器
    function initializeEventListeners() {
        // 表單提交
        document.getElementById('stockCalculator').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('表單提交事件觸發'); // 調試用
            calculateTradingCost();
        });

        // 券商選擇變化
        document.getElementById('broker').addEventListener('change', function() {
            handleBrokerChange(this.value);
        });

        // 交易類型選擇 - 直接監聽 radio button
        document.querySelectorAll('input[name="stockType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Radio button 改變:', this.value); // 調試用
                if (this.checked) {
                    selectStockType(this.value, this.parentElement);
                }
            });
        });

        // 測試按鈕點擊
        document.querySelector('.calculate-btn').addEventListener('click', function(e) {
            console.log('計算按鈕被點擊'); // 調試用
        });
    }

    // 處理券商選擇變化
    function handleBrokerChange(brokerValue) {
        const customDiscountGroup = document.getElementById('customDiscountGroup');
        
        if (brokerValue === 'custom') {
            customDiscountGroup.style.display = 'block';
            document.getElementById('customDiscount').required = true;
        } else {
            customDiscountGroup.style.display = 'none';
            document.getElementById('customDiscount').required = false;
            // 清空自訂值
            document.getElementById('customDiscount').value = '';
            document.getElementById('customMinFee').value = '1';
        }
    }

    // 獲取價格對應的跳動單位
    function getTickSize(price) {
        if (price < 10) return 0.01;
        if (price < 50) return 0.05;
        if (price < 100) return 0.1;
        if (price < 500) return 0.5;
        if (price < 1000) return 1;
        return 5;
    }

    // 選擇交易類型 - 增加跨平台兼容性
    function selectStockType(type, element) {
        console.log('選擇交易類型:', type); // 調試用
        
        // 移除所有 active class
        document.querySelectorAll('.radio-group').forEach(group => {
            group.classList.remove('active');
        });
        
        // 選擇對應的 radio button
        const selectedRadio = document.getElementById(type);
        selectedRadio.checked = true;
        element.classList.add('active');
        
        // 更新數量標籤
        const quantityLabel = document.getElementById('quantityLabel');
        if (type === 'lot') {
            quantityLabel.innerHTML = '張數 <span class="required">*必選</span>';
            document.getElementById('quantity').placeholder = '請輸入張數 (預設為1)';
        } else {
            quantityLabel.innerHTML = '股數 <span class="required">*必選</span>';
            document.getElementById('quantity').placeholder = '請輸入股數 (預設為1)';
        }
        
        console.log('交易類型選擇完成:', selectedRadio.checked); // 調試用
    }

    // 跨平台數字格式化
    function formatNumber(num) {
        if (typeof Intl !== 'undefined' && Intl.NumberFormat) {
            try {
                return new Intl.NumberFormat('zh-TW').format(num);
            } catch (e) {
                // 降級處理
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        } else {
            // 手動實現千分位格式化
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
    }

    // 計算交易成本
    function calculateTradingCost() {
        const broker = document.getElementById('broker').value;
        const buyPrice = parseFloat(document.getElementById('buyPrice').value);
        const sellPrice = parseFloat(document.getElementById('sellPrice').value);
        const stockTypeElement = document.querySelector('input[name="stockType"]:checked');
        let quantity = document.getElementById('quantity').value;

        // 檢查必填欄位
        if (!broker) {
            alert('請選擇券商！');
            return;
        }
        
        if (!buyPrice || buyPrice <= 0) {
            alert('請輸入有效的買進價格！');
            return;
        }
        
        if (!sellPrice || sellPrice <= 0) {
            alert('請輸入有效的賣出價格！');
            return;
        }
        
        if (!stockTypeElement) {
            alert('請選擇交易類型（整張或零股）！');
            return;
        }

        // 檢查自選折數
        if (broker === 'custom') {
            const customDiscount = document.getElementById('customDiscount').value;
            if (!customDiscount || parseFloat(customDiscount) <= 0 || parseFloat(customDiscount) > 10) {
                alert('請輸入有效的折數 (0.1-10)！');
                return;
            }
        }

        // 如果數量空白，預設為1
        if (!quantity || quantity === '') {
            quantity = 1;
            document.getElementById('quantity').value = 1;
        } else {
            quantity = parseInt(quantity);
            if (quantity <= 0) {
                alert('請輸入有效的數量！');
                return;
            }
        }

        const stockType = stockTypeElement.value;

        try {

        // 計算股票總價
        let buyStockAmount, sellStockAmount;
        if (stockType === 'lot') {
            buyStockAmount = buyPrice * quantity * 1000; // 一張 = 1000股
            sellStockAmount = sellPrice * quantity * 1000;
        } else {
            buyStockAmount = buyPrice * quantity;
            sellStockAmount = sellPrice * quantity;
        }

        // 券商手續費折扣計算
        function getBrokerInfo(broker, stockAmount) {
            switch (broker) {
                case 'fubon':
                    // 富邦證券：股票金額100萬為分界
                    return {
                        discountRate: stockAmount >= 1000000 ? 0.6 : 0.18,
                        name: '富邦證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'shinko':
                    // 新光證券：1折
                    return {
                        discountRate: 0.1,
                        name: '新光證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'president':
                    // 統一證券：1.68折，最低手續費統一為1元
                    return {
                        discountRate: 0.168,
                        name: '統一證券',
                        minFeeRegular: 1,
                        minFeeOdd: 1
                    };
                case 'sinopac':
                    // 永豐證券：2折，零股最低1元
                    return {
                        discountRate: 0.2,
                        name: '永豐證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'taishin':
                    // 台新證券：2折
                    return {
                        discountRate: 0.2,
                        name: '台新證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'pocketsec':
                    // 口袋證券：2.8折
                    return {
                        discountRate: 0.28,
                        name: '口袋證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'landbank':
                    // 土銀證券：3折
                    return {
                        discountRate: 0.3,
                        name: '土銀證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'bot':
                    // 臺銀證券：3.5折
                    return {
                        discountRate: 0.35,
                        name: '臺銀證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'megasec':
                    // 兆豐證券：5折
                    return {
                        discountRate: 0.5,
                        name: '兆豐證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'tcbsec':
                    // 合庫證券：5折
                    return {
                        discountRate: 0.5,
                        name: '合庫證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'changhuasec':
                    // 彰銀證券：5折
                    return {
                        discountRate: 0.5,
                        name: '彰銀證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'ctbc':
                    // 中國信託證券：6折
                    return {
                        discountRate: 0.6,
                        name: '中國信託證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'firstsec':
                    // 第一金證券：6折，零股最低2元
                    return {
                        discountRate: 0.6,
                        name: '第一金證券',
                        minFeeRegular: 20,
                        minFeeOdd: 2
                    };
                case 'sunnybank':
                    // 陽信證券：6折
                    return {
                        discountRate: 0.6,
                        name: '陽信證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'esun':
                    // 玉山證券：6折，零股最低1元
                    return {
                        discountRate: 0.6,
                        name: '玉山證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'kgi':
                    // 凱基證券：6折，零股最低1元
                    return {
                        discountRate: 0.6,
                        name: '凱基證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'yuanta':
                    // 元大證券：6折，零股最低1元
                    return {
                        discountRate: 0.6,
                        name: '元大證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'cathaysec':
                    // 國泰證券：2.8折，零股最低1元
                    return {
                        discountRate: 0.28,
                        name: '國泰證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'capital':
                    // 群益證券：6折，零股最低1元
                    return {
                        discountRate: 0.6,
                        name: '群益證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'masterlink':
                    // 元富證券：6.5折，零股最低1元
                    return {
                        discountRate: 0.65,
                        name: '元富證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'entrust':
                    // 華南永昌證券：6.5折，零股最低1元
                    return {
                        discountRate: 0.65,
                        name: '華南永昌證券',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
                case 'custom':
                    // 自選折數
                    const customDiscount = parseFloat(document.getElementById('customDiscount').value);
                    const customMinFee = parseInt(document.getElementById('customMinFee').value) || 1;
                    
                    if (!customDiscount || customDiscount <= 0 || customDiscount > 10) {
                        throw new Error('請輸入有效的折數 (0.1-10)');
                    }
                    
                    return {
                        discountRate: customDiscount / 10, // 6折 = 0.6
                        name: `自選 ${customDiscount}折`,
                        minFeeRegular: 20,
                        minFeeOdd: customMinFee
                    };
                default:
                    return {
                        discountRate: 1.0,
                        name: '一般券商',
                        minFeeRegular: 20,
                        minFeeOdd: 1
                    };
            }
        }

        const buyBrokerInfo = getBrokerInfo(broker, buyStockAmount);
        const sellBrokerInfo = getBrokerInfo(broker, sellStockAmount);

        // 計算原始手續費（未折扣）
        let buyCommissionOriginal = buyStockAmount * 0.001425;
        let sellCommissionOriginal = sellStockAmount * 0.001425;

        // 計算折扣後手續費
        let buyCommission = buyCommissionOriginal * buyBrokerInfo.discountRate;
        let sellCommission = sellCommissionOriginal * sellBrokerInfo.discountRate;

        // 最低手續費處理（根據券商和交易類型）
        if (stockType === 'lot') {
            // 整張交易
            if (buyCommissionOriginal < buyBrokerInfo.minFeeRegular) buyCommissionOriginal = buyBrokerInfo.minFeeRegular;
            if (sellCommissionOriginal < sellBrokerInfo.minFeeRegular) sellCommissionOriginal = sellBrokerInfo.minFeeRegular;
            if (buyCommission < buyBrokerInfo.minFeeRegular) buyCommission = buyBrokerInfo.minFeeRegular;
            if (sellCommission < sellBrokerInfo.minFeeRegular) sellCommission = sellBrokerInfo.minFeeRegular;
        } else {
            // 零股交易
            if (buyCommissionOriginal < buyBrokerInfo.minFeeOdd) buyCommissionOriginal = buyBrokerInfo.minFeeOdd;
            if (sellCommissionOriginal < sellBrokerInfo.minFeeOdd) sellCommissionOriginal = sellBrokerInfo.minFeeOdd;
            if (buyCommission < buyBrokerInfo.minFeeOdd) buyCommission = buyBrokerInfo.minFeeOdd;
            if (sellCommission < sellBrokerInfo.minFeeOdd) sellCommission = sellBrokerInfo.minFeeOdd;
        }

        // 重新計算折扣金額（因為可能有最低手續費調整）
        const buyDiscount = buyCommissionOriginal - buyCommission;
        const sellDiscount = sellCommissionOriginal - sellCommission;
        const totalDiscount = buyDiscount + sellDiscount;

        // 證券交易稅（賣出金額 × 0.3%）
        const tax = sellStockAmount * 0.003;

        // 計算總成本（使用未折扣手續費）
        const totalBuyCostOriginal = buyStockAmount + buyCommissionOriginal;
        const netSellProceedsOriginal = sellStockAmount - sellCommissionOriginal - tax;

        // 計算實際成本（使用折扣後手續費）
        const totalBuyCost = buyStockAmount + buyCommission;
        const netSellProceeds = sellStockAmount - sellCommission - tax;

        // 計算損益（基於實際折扣後的費用）
        const totalCosts = buyCommission + sellCommission + tax;
        const profitAmount = netSellProceeds - totalBuyCost;
        const profitRate = (profitAmount / totalBuyCost) * 100;

        // 顯示結果
        updateResults({
            buyStockAmount,
            buyCommissionOriginal,
            totalBuyCostOriginal,
            sellStockAmount,
            sellCommissionOriginal,
            tax,
            netSellProceedsOriginal,
            totalCosts,
            totalDiscount,
            profitAmount,
            profitRate,
            buyBrokerInfo,
            sellBrokerInfo
        });
        
        } catch (error) {
            alert('計算錯誤：' + error.message);
        }
    }

    // 更新結果顯示 - 使用跨平台數字格式化
    function updateResults(data) {
        const resultsContainer = document.getElementById('results');
        let resultsHTML = '';

        // 買入結果區塊
        if (data.hasBuyPrice) {
            resultsHTML += `
                <div class="result-section buy-section">
                    <h3>🟢 買入成本</h3>
                    <div class="result-item">
                        <span>股票金額：</span>
                        <span>NT$ ${formatNumber(data.buyStockAmount)}</span>
                    </div>
                    <div class="result-item">
                        <span>手續費 (0.1425%) ${getDiscountText(data.buyBrokerInfo)}：</span>
                        <span>NT$ ${formatNumber(Math.round(data.buyCommissionOriginal))}</span>
                    </div>
                    <div class="result-item">
                        <span>總買入成本 (試算)：</span>
                        <span>NT$ ${formatNumber(Math.round(data.totalBuyCostOriginal))}</span>
                    </div>
                </div>
            `;
        }

        // 賣出結果區塊
        if (data.hasSellPrice) {
            resultsHTML += `
                <div class="result-section sell-section">
                    <h3>🔴 賣出收益</h3>
                    <div class="result-item">
                        <span>股票金額：</span>
                        <span>NT$ ${formatNumber(data.sellStockAmount)}</span>
                    </div>
                    <div class="result-item">
                        <span>手續費 (0.1425%) ${getDiscountText(data.sellBrokerInfo)}：</span>
                        <span>NT$ ${formatNumber(Math.round(data.sellCommissionOriginal))}</span>
                    </div>
                    <div class="result-item">
                        <span>證券交易稅 (0.3%)：</span>
                        <span>NT$ ${formatNumber(Math.round(data.tax))}</span>
                    </div>
                    <div class="result-item">
                        <span>淨賣出收益 (試算)：</span>
                        <span>NT$ ${formatNumber(Math.round(data.netSellProceedsOriginal))}</span>
                    </div>
                </div>
            `;
        }

        // 費用分析區塊
        resultsHTML += `
            <div class="result-section profit-section">
                <h3>📊 費用分析</h3>
                <div class="result-item">
                    <span>總交易費用：</span>
                    <span>NT$ ${formatNumber(Math.round(data.totalCosts))}</span>
                </div>
                <div class="result-item">
                    <span>手續費折扣優惠：</span>
                    <span style="color: #27ae60;">-NT$ ${formatNumber(Math.round(data.totalDiscount))}</span>
                </div>
        `;

        // 只有在買入和賣出價格都有時才顯示損益
        if (data.hasBuyPrice && data.hasSellPrice) {
            let profitClass;
            let profitAmountText, profitRateText;

            if (data.profitAmount > 0) {
                profitClass = 'profit-positive';
                profitAmountText = `+NT$ ${formatNumber(Math.round(data.profitAmount))}`;
                profitRateText = `+${data.profitRate.toFixed(2)}%`;
            } else if (data.profitAmount < 0) {
                profitClass = 'profit-negative';
                profitAmountText = `-NT$ ${formatNumber(Math.round(Math.abs(data.profitAmount)))}`;
                profitRateText = `${data.profitRate.toFixed(2)}%`;
            } else {
                profitClass = 'profit-zero';
                profitAmountText = `NT$ 0`;
                profitRateText = `0.00%`;
            }

            resultsHTML += `
                <div class="result-item">
                    <span>試算後損益：</span>
                    <span class="${profitClass}">${profitAmountText}</span>
                </div>
                <div class="result-item">
                    <span>損益率：</span>
                    <span class="${profitClass}">${profitRateText}</span>
                </div>
            `;
        }

        resultsHTML += `
            </div>
        `;

        // 更新結果容器
        resultsContainer.innerHTML = resultsHTML;
        resultsContainer.style.display = 'block';
        
        // 跨平台滾動到結果區域
        try {
            resultsContainer.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        } catch (e) {
            // 降級處理：直接滾動
            resultsContainer.scrollIntoView();
        }
    }
</script>
```

</body>
</html>
