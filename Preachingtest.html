<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>傳道整理表 1.1.0</title>
    <style>
        :root {
            --primary-green: #43a047;
            --dark-green: #2e7d32;
            --light-green-bg: #f1f8e9;
            --gradient-start: #66bb6a;
            --gradient-end: #a8e063;
            --danger-red: #e53935;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #333;
        }

        /* --- 導航選單 (Top Left Menu) --- */
        nav {
            background: white;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-title {
            font-weight: bold;
            color: var(--primary-green);
            margin-right: 30px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        
        .nav-title span { margin-left: 8px; }

        .menu-items {
            display: flex;
            gap: 10px;
        }

        .menu-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s;
        }

        .menu-btn.active {
            background-color: var(--primary-green);
            color: white;
            font-weight: bold;
        }

        .menu-btn:hover:not(.active) {
            background-color: #f1f8e9;
            color: var(--primary-green);
        }

        /* --- 主要容器 --- */
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 30px;
            min-height: 500px;
        }

        /* 頁面切換控制 */
        .page-section {
            display: none; /* 預設隱藏 */
            animation: fadeIn 0.4s ease;
        }
        .page-section.active-section {
            display: block; /* 顯示當前頁 */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--dark-green);
            border-bottom: 3px solid var(--gradient-end);
            padding-bottom: 10px;
            margin-top: 0;
        }

        /* --- 表單樣式 --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-full-width { grid-column: 1 / -1; }

        .form-group { margin-bottom: 5px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-green);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #c5e1a5;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.15);
        }
        
        input[readonly] {
            background-color: #f9f9f9;
            color: #777;
            cursor: not-allowed;
        }

        /* 狀態提示 */
        .status-bar {
            grid-column: 1 / -1;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-bottom: 15px;
            display: none; /* 預設隱藏 */
        }
        .status-found { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .status-new { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        button.submit-btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: linear-gradient(to right, #43a047, #66bb6a);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- 後台工具列 --- */
        .backend-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fafafa;
            border-radius: 8px;
        }

        .batch-delete-btn {
            background-color: #ffebee;
            color: var(--danger-red);
            border: 1px solid #ffcdd2;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .batch-delete-btn:hover { background-color: #ffcdd2; }

        /* --- 表格樣式 --- */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #66bb6a;
            color: white;
            white-space: nowrap;
        }
        
        /* Checkbox 欄位寬度 */
        th.check-col, td.check-col { width: 40px; text-align: center; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: white;
        }
        .tag-me { background-color: #26a69a; }
        .tag-other { background-color: #ef5350; }

        /* --- RWD 手機版 --- */
        @media (max-width: 768px) {
            .container { margin: 10px auto; padding: 20px; width: 95%; }
            .form-grid { grid-template-columns: 1fr; }
            
            /* 手機版表格轉卡片 */
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                margin-bottom: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                position: relative;
                padding-left: 40px; /* 留給 checkbox 的空間 */
            }

            /* Checkbox 在手機版改為絕對定位在左側 */
            td.check-col {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-right: 1px solid #f0f0f0;
                background-color: #fafafa;
                border-bottom: none;
            }

            td:not(.check-col) {
                padding: 10px 15px;
                text-align: right;
                display: flex;
                justify-content: flex-end;
                align-items: center;
                border-bottom: 1px solid #f5f5f5;
            }

            td:not(.check-col)::before {
                content: attr(data-label);
                position: absolute;
                left: 50px; /* 避開 checkbox */
                font-weight: bold;
                color: var(--dark-green);
            }

            td[data-label="內容"] {
                display: block;
                text-align: left;
                padding-top: 35px;
            }
            td[data-label="內容"]::before { top: 10px; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--primary-green)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        <span>傳道整理系統</span>
    </div>
    <div class="menu-items">
        <button class="menu-btn active" onclick="switchPage('entry')">傳道登錄</button>
        <button class="menu-btn" onclick="switchPage('backend')">後台資料</button>
    </div>
</nav>

<div class="container">

    <div id="entrySection" class="page-section active-section">
        <h2>傳道登錄表</h2>
        
        <div id="statusMsg" class="status-bar"></div>

        <div class="form-grid">
            <div class="form-group">
                <label for="idInput">編號</label>
                <input type="text" id="idInput" placeholder="輸入編號 (例: 0001)" oninput="handleIdInput()">
            </div>

            <div class="form-group">
                <label for="nameInput">姓名</label>
                <input type="text" id="nameInput" placeholder="輸入姓名 (例: 良丞)" oninput="handleNameInput()">
            </div>

            <div class="form-group">
                <label for="recordDate">日期</label>
                <input type="date" id="recordDate">
            </div>

            <div class="form-group">
                <label for="replyType">回覆類型</label>
                <select id="replyType">
                    <option value="我回覆">我回覆</option>
                    <option value="對方回覆" id="otherReplyOption">對方回覆</option>
                </select>
            </div>

            <div class="form-group form-full-width">
                <label for="content">回覆內容紀錄</label>
                <textarea id="content" rows="5" placeholder="請輸入對話重點或備忘..."></textarea>
            </div>
        </div>
        
        <button class="submit-btn" onclick="submitData()">登錄資料</button>
    </div>

    <div id="backendSection" class="page-section">
        <h2>後台登錄資料</h2>
        
        <div class="backend-toolbar">
            <span style="font-size: 0.9rem; color: #666;">
                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()"> 全選 / 取消
            </span>
            <button class="batch-delete-btn" onclick="deleteSelected()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                刪除選取項目
            </button>
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th class="check-col"></th> <th width="10%">編號</th>
                    <th width="15%">姓名</th>
                    <th width="15%">日期</th>
                    <th width="15%">類型</th>
                    <th width="45%">內容</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

</div>

<script>
    // --- 資料庫初始化 ---
    const STORAGE_KEY = 'missionary_data_v3';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // 自動遷移舊資料 (相容 v1, v2)
    if (db.length === 0) {
        const oldV2 = localStorage.getItem('missionary_data_v2');
        const oldV1 = localStorage.getItem('missionary_data_v1');
        if (oldV2) db = JSON.parse(oldV2);
        else if (oldV1) db = JSON.parse(oldV1);
        
        // 如果完全沒資料，建立預設
        if (db.length === 0) {
            db.push({ id: '0001', name: '良丞', logs: [] });
        }
        saveData();
    }

    // 初始化日期
    document.getElementById('recordDate').valueAsDate = new Date();
    // 渲染表格
    renderTable();

    // --- 變更 1 & 2: 頁面切換 ---
    function switchPage(pageName) {
        // 切換按鈕樣式
        document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
        if(pageName === 'entry') document.querySelectorAll('.menu-btn')[0].classList.add('active');
        else document.querySelectorAll('.menu-btn')[1].classList.add('active');

        // 切換區塊顯示
        document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active-section'));
        if(pageName === 'entry') document.getElementById('entrySection').classList.add('active-section');
        else {
            document.getElementById('backendSection').classList.add('active-section');
            renderTable(); // 切換到後台時重新渲染，確保資料最新
        }
    }

    // --- 變更 1 & 2: 雙向聯動邏輯 ---
    
    // 輸入編號 -> 找名字
    function handleIdInput() {
        const idVal = document.getElementById('idInput').value.trim();
        const user = db.find(u => u.id === idVal);
        
        const nameInput = document.getElementById('nameInput');
        const statusMsg = document.getElementById('statusMsg');
        
        if (user) {
            nameInput.value = user.name; // 自動填入名字
            showStatus(`✔ 已找到舊資料：${user.name}`, 'found');
            updateReplyOption(user.name); // 變更 4
        } else {
            // 如果編號不存在，不要清空名字（可能是新編號），但重置狀態
            if(idVal.length >= 4) {
                 showStatus(`✚ 這是新的編號，請輸入姓名以建立檔案`, 'new');
            } else {
                 statusMsg.style.display = 'none';
            }
            updateReplyOption(null);
        }
    }

    // 輸入名字 -> 找編號
    function handleNameInput() {
        const nameVal = document.getElementById('nameInput').value.trim();
        const user = db.find(u => u.name === nameVal);

        const idInput = document.getElementById('idInput');
        
        if (user) {
            idInput.value = user.id; // 自動填入編號
            showStatus(`✔ 已找到舊資料：編號 ${user.id}`, 'found');
            updateReplyOption(user.name); // 變更 4
        } else {
            // 新名字 -> 自動生成新編號 (顯示但不鎖死，允許使用者修改)
            // 只有當編號欄位是空的，才自動配號，避免干擾手動輸入
            if (idInput.value === '') {
                const newId = generateNewId();
                showStatus(`✚ 新朋友！系統建議編號：${newId}`, 'new');
                // 這裡選擇不直接填入 input，改為提示，或者您可以選擇直接填入:
                idInput.value = newId; 
            }
            updateReplyOption(null);
        }
    }

    function showStatus(msg, type) {
        const el = document.getElementById('statusMsg');
        el.textContent = msg;
        el.className = `status-bar status-${type}`;
        el.style.display = 'block';
    }

    // --- 變更 4: 更新「對方回覆」的文字 ---
    function updateReplyOption(name) {
        const option = document.getElementById('otherReplyOption');
        if (name) {
            option.textContent = `對方回覆 (${name})`;
        } else {
            option.textContent = `對方回覆`;
        }
    }

    // --- 資料提交 ---
    function submitData() {
        const id = document.getElementById('idInput').value.trim();
        const name = document.getElementById('nameInput').value.trim();
        const date = document.getElementById('recordDate').value;
        const typeRaw = document.getElementById('replyType').value;
        const content = document.getElementById('content').value.trim();

        if (!id || !name || !date || !content) {
            alert("請填寫所有欄位");
            return;
        }

        // 處理類型文字 (如果選的是「對方回覆」，儲存時存入「對方回覆 (Name)」或單純「對方回覆」)
        let finalType = typeRaw;
        if (typeRaw === '對方回覆' && name) {
            // 檢查是否已經包含了名字，如果 select 本身已經變了
            const optionText = document.getElementById('otherReplyOption').textContent;
            // 為了資料庫乾淨，我們存 "對方回覆" 加上名字，或者前端顯示時再加?
            // 需求說「帶入對方姓名」，這裡直接存進去比較直觀
            finalType = `對方回覆 (${name})`;
        }

        let user = db.find(u => u.id === id);

        if (user) {
            // ID 存在，檢查名字是否相符
            if (user.name !== name) {
                if(!confirm(`編號 ${id} 原本是 ${user.name}，您確定要改成 ${name} 嗎？`)) return;
                user.name = name; // 更新名字
            }
            user.logs.push({ date, type: finalType, content });
            alert(`已更新 ${name} 的資料`);
        } else {
            // 新 ID
            // 再次檢查名字是否已被其他 ID 使用
            const nameExist = db.find(u => u.name === name);
            if (nameExist) {
                alert(`錯誤：${name} 已經存在於編號 ${nameExist.id}，請確認。`);
                return;
            }

            db.push({
                id: id,
                name: name,
                logs: [{ date, type: finalType, content }]
            });
            alert(`已建立新檔案：${name} (${id})`);
        }

        saveData();
        resetForm();
    }

    // --- 變更 3: 後台表格與批次刪除 ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        // 排序：新 ID 在前
        const sortedDb = [...db].sort((a, b) => b.id - a.id);

        sortedDb.forEach(user => {
            // 如果無紀錄
            if (!user.logs || user.logs.length === 0) {
                tbody.appendChild(createRow(user.id, user.name, '', '', '(尚無紀錄)', user.id));
                return;
            }

            // 日期新到舊
            const sortedLogs = [...user.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedLogs.forEach((log) => {
                // 每一行都帶有 user.id 作為 value，方便刪除邏輯辨識
                // 注意：這裡的刪除邏輯是「選取某行紀錄」還是「選取這個人」？
                // 根據需求「刪除的選項功能更變...點選刪除後彈出選單」，通常指刪除該筆用戶資料。
                // 為了簡化，這裡 checkbox 代表「選取這個人(編號)」。
                // 所以多行紀錄如果是同一個人，checkbox value 是一樣的。
                
                tbody.appendChild(createRow(user.id, user.name, log.date, log.type, log.content, user.id));
            });
        });
    }

    function createRow(id, name, date, type, content, uniqueValue) {
        const tr = document.createElement('tr');
        
        let typeClass = 'tag-other';
        if (type === '我回覆') typeClass = 'tag-me';
        
        const typeHtml = type ? `<span class="tag ${typeClass}">${type}</span>` : '';

        // Checkbox: 具有相同的 name="selectUser"，value 為 ID
        tr.innerHTML = `
            <td class="check-col">
                <input type="checkbox" name="selectUser" value="${uniqueValue}">
            </td>
            <td data-label="編號">${id}</td>
            <td data-label="姓名"><strong>${name}</strong></td>
            <td data-label="日期">${date}</td>
            <td data-label="類型">${typeHtml}</td>
            <td data-label="內容">${content}</td>
        `;
        return tr;
    }

    // 全選/取消全選
    function toggleSelectAll() {
        const mainCheck = document.getElementById('selectAll');
        const checkboxes = document.getElementsByName('selectUser');
        checkboxes.forEach(cb => cb.checked = mainCheck.checked);
    }

    // 執行批次刪除
    function deleteSelected() {
        const checkboxes = document.getElementsByName('selectUser');
        const selectedIds = new Set(); // 使用 Set 避免同一個人多筆紀錄被重複計算
        
        checkboxes.forEach(cb => {
            if (cb.checked) selectedIds.add(cb.value);
        });

        if (selectedIds.size === 0) {
            alert("請先勾選要刪除的項目！");
            return;
        }

        // 彈出確認選單
        const confirmMsg = `您選取了 ${selectedIds.size} 位傳道對象（編號: ${Array.from(selectedIds).join(', ')}）。\n\n確定要「永久刪除」這些檔案及其所有紀錄嗎？`;
        
        if (confirm(confirmMsg)) {
            // 執行刪除
            db = db.filter(user => !selectedIds.has(user.id));
            saveData();
            renderTable(); // 重繪表格
            document.getElementById('selectAll').checked = false; // 重置全選紐
            alert("刪除完成！");
            
            // 如果剛好刪到正在輸入的，重置表單
            handleIdInput();
        }
    }

    // --- 工具函式 ---
    function generateNewId() {
        if (db.length === 0) return '0001';
        const maxId = db.reduce((max, user) => Math.max(max, parseInt(user.id, 10)), 0);
        return String(maxId + 1).padStart(4, '0');
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    }

    function resetForm() {
        document.getElementById('content').value = '';
        document.getElementById('idInput').value = '';
        document.getElementById('nameInput').value = '';
        document.getElementById('statusMsg').style.display = 'none';
        updateReplyOption(null);
    }
</script>

</body>
</html>
